# P2.3 Rollout Plan — Port `check_modules.py` to TypeScript

_Last updated: October 1, 2025_

> **Status:** The TypeScript implementation (`scripts/check-modules/index.ts`) is now the default Stage 5b runner. This plan is archived as a record of the rollout; outstanding follow-ups live in the roadmap and comparison harness docs.

## Status Snapshot

- [x] **Phase 0 – Foundations:** Rule inventory, registry schema, curated fixtures, and comparison harness (incl. CI workflow) ✅ Completed Oct 2025
- [x] **Phase 1 – TypeScript scaffold:** Implemented TS pipeline core and shipped orchestrator wiring (`--checks` flag) ✅ Completed Oct 2025
- [x] **Phase 2 – Extended checks:** Ported ESLint/deprecation helpers, restored dependency formatting, and matched Python parity ✅ Completed Oct 2025
- [x] **Phase 3 – Cutover:** TypeScript stage is now the default; Python fallback retained behind `--checks=legacy` for parity checks ✅ Completed Oct 2025

## 1. Objectives & Success Criteria

- **Primary goal:** Replace the Python-based `check_modules.py` pipeline stage with a TypeScript implementation that integrates with the shared utility layer introduced in P2.1 — ✅ achieved.
- **Parity:** Preserve the existing rule coverage and output contract (`modules.stage.5.json`, markdown summaries, stats) so downstream stages remain unchanged.
- **DX improvements:** Enable feature-flagged execution (`--checks=legacy|ts`) to roll out the new implementation gradually without breaking current automation.
- **Observability:** Capture structured logs and rule-level metrics to evaluate performance and correctness compared with the Python version.

## 2. Scope Overview

- Re-implement the fast checks previously coded in `scripts/check_modules.py` using the shared TypeScript utilities (`fs-utils`, `logger`, schema validation`).
- Maintain compatibility with the JSON schema for stage 5 artifacts (`modules.stage.5.json`).
- Support both orchestrator-driven runs and ad-hoc CLI invocation.
- Introduce configuration that maps each rule to metadata (category, severity, autofixable) in preparation for P4.1.

## 3. Phased Approach

| Phase                            | Focus                                                                                                                                                                                       | Deliverables                                                                                                                                                                                                                            | Feature Flags                                          |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------ |
| **Phase 0: Foundations**         | Audit existing rules and categorize them (fast text scans, regex scans, external checks). Build a rule registry schema.                                                                     | ✅ Completed (Oct 2025): [Rule inventory](p2.3-rule-inventory.md), JSON schema for rule registry, [fixture harness plan](p2.3-fixture-harness-plan.md), [fixture selection](p2.3-fixture-selection.md), comparison harness + CI wiring. | n/a                                                    |
| **Phase 1: TypeScript scaffold** | Create `scripts/check-modules.ts` mirroring the legacy pipeline I/O (read stage 4, write stage 5). Implement the text scanning rules using the shared FS utilities and concurrency helpers. | ✅ Landed in Oct 2025 with orchestrator wiring (`--checks`).                                                                                                                                                                            | `--checks=ts` (default), `--checks=legacy` fallback    |
| **Phase 2: Extended checks**     | Port the ESLint/deprecation sub-checks and integrate Ajv validation directly into the TS pipeline.                                                                                          | ✅ ESLint/deprecation helpers and dependency formatting now align with Python output.                                                                                                                                                   | `--checks=ts` (default), `--checks=legacy` fallback    |
| **Phase 3: Cutover**             | Flip the orchestrator default to TypeScript after comparison runs pass and performance targets are met. Retire Python fallback after a release cycle.                                       | ✅ Stage graph updated, docs refreshed; Python kept behind `--checks=legacy` plus comparison harness for regressions.                                                                                                                   | `--checks=legacy` retained for comparison harness only |

## 4. Guardrails & Tooling Updates

- **Comparison harness:** The CLI now runs both implementations against curated fixtures, emits `diff.json`/`diff.md`, and is exercised in CI via the scheduled/manual `check-modules-compare` workflow.
- **Schema validation:** Continue calling `validateStageFile("modules.stage.5", ...)` within the TS stage to enforce contracts.
- **Rate limiting:** Reuse the shared rate limiter if external HTTP calls remain necessary; otherwise ensure future network calls are coordinated.
- **Logging:** Adopt structured JSON logs with rule identifiers to feed future dashboards.

## 5. Testing Strategy

- Unit-like tests for rule helpers (regex/text scanners) using Jest or a lightweight harness executed via Node.
- Fixture-based regression tests comparing legacy vs TS outputs on the existing curated module set.
- CI job matrix exercises the `--checks=ts` default, the optional `--checks=legacy` fallback, and the comparison harness workflow to guard against regressions.

## 6. Documentation & Communication

- Update `docs/architecture.md` when the TypeScript stage lands and again when the Python fallback is removed.
- Publish rollout status in the roadmap (P2.3 row) and note major milestones in release notes.
- Communicate CLI changes (`--checks` options, new logs) in `docs/pipeline/orchestrator-cli-reference.md` (✅ updated Oct 2025).

## 7. Risks & Mitigations

| Risk                                                                  | Mitigation                                                                                                                                  |
| --------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| Diverging rule behavior between Python and TypeScript implementations | Use fixture diffing + snapshot tests during Phase 2 before enabling TS by default.                                                          |
| Performance regressions due to synchronous file reads                 | Utilize concurrency helpers and chunked scanning to parallelize safe operations.                                                            |
| ESLint/deprecation helpers lacking feature parity                     | Wrap existing JS helpers (`eslint_checks.py`, `deprecation_check.py`) temporarily via subprocess while porting to TypeScript incrementally. |
| Contributor confusion during dual-runtime period                      | Document the feature flag and default behavior prominently in CLI docs and README.                                                          |

## 8. Timeline Targets (Tentative)

1. **Phase 0 (1 week):** Rule inventory, registry schema, fixture adjustments — ✅ completed Oct 2025.
2. **Phase 1 (2 weeks):** TypeScript stage scaffold, orchestrator wiring, initial flag rollout in CI.
3. **Phase 2 (2–3 weeks):** Port extended checks, implement comparison harness, gather metrics.
4. **Phase 3 (1 week monitoring + release):** Flip default to TS, archive Python fallback post-release (✅ default flipped Oct 2025; fallback retained for comparisons).

_Assumptions:_ Dedicated time from the pipeline maintainers, ability to extend the fixtures repo within the same sprint, and access to sample modules for benchmarking.

---

### Rollout outcome

- TypeScript stage (`scripts/check-modules/index.ts`) now drives Stage 5b in the orchestrator and manual runs (`node scripts/check-modules/index.ts`).
- Legacy Python stage is frozen; invoke it via `--checks=legacy` or the comparison harness when parity investigations are required.
- Comparison harness remains scheduled weekly to catch regressions and will be extended with additional artifact diffing as tracked in the fixture plan.

Future adjustments should target incremental rule improvements (P4.x) rather than parity work.
